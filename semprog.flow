import net/url_parameter;
import fs/filesystem;
import parser/parse;
import typecheck;
import module;
import algebra;

main() -> void {
    println("Semantic programming framework\n");
    file = getUrlParameter("file");
    if (!fileExists(file)) {
        println("File: " + file  + " doesn't exist");
    } else {
        ext = getFileExt(file);
        if (ext != ".sem") {
            println("Extension: " + ext  + " mismatches the expected .sem");
        } else {
            println(evalAlgebra2s(fullAlgebra));
            show = algebraShow(fullAlgebra);
            eval = algebraEval(fullAlgebra);
            src = getFileContent(file);
            name = changeFileExt(src, "");
            module = typecheckModule(parseModule(src, name), fullAlgebra);

            algebra1 = EvalAlgebra("module algebra", 
                fold(module.defs, fullAlgebra.opers, \acc, def -> 
                    concat(acc, [makeDefOper(def)])
                ),
                fullAlgebra.consts
            );

            show1 = algebraShow(algebra1);
            eval1 = algebraEval(algebra1);

            //module = parseModule(src, name);
            println("Module:\n" + module2s(module, show) + "\n\n");
            println(
                strGlue(map(module.defs, \def -> 
                    //algTypedTerm2s(def.term) + "\n" +
                    //def2s(def, show1)
                    "eval[" + algTypedTerm2s(def.term) + "] = " +
                    toString(eval1.eval(def.term, makeTree()))
                ), "\n")
            );
        }
    }
    quit(0);
}
