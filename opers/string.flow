import eval;
import dynamic;
import common_types;

export {
    // String operations
    makeStringConst(name : string) -> EvalOper;
    stringConst : EvalConst;
    stringOpers : [EvalOper];
}

stringConst = EvalConst(stringType, \s,__ -> s);

makeStringConst(name : string) -> EvalOper {
    EvalOper(name, 
        funcAlgType([], stringType), 
        \args -> Eval(\vals, conf ->
            if (length(args) != 0) flow(undefVal) else flow(name)
        ),
        showConstEvalOper(name)
    )
}

stringOpers = [
    EvalOper("println", 
        funcAlgType([variadicAlgType(stringType)], unitType), 
        \args -> Eval(\vals, conf -> {
            iter(args, \arg -> println(arg.eval(vals, conf)));
            flow(UnitVal());
        }),
        showDfEvalOper("println")
    ),
    EvalOper("+", 
        funcAlgType([variadicAlgType(stringType)], stringType), 
        \args -> Eval(\vals, conf -> 
            flow(concatStrings(map(args, \arg -> 
                flow2s(arg.eval(vals, conf))
            )))
        ),
        showVariadicEvalOper("+")
    ),
    EvalOper("i2s", 
        funcAlgType([intType], stringType), 
        \args -> Eval(\vals, conf -> 
            if (length(args) != 1) flow(undefVal) else {
                flow(i2s(flow2i(args[0].eval(vals, conf))))
            }
        ),
        showDfEvalOper("i2s")
    ),
    EvalOper("b2s", 
        funcAlgType([boolType], stringType), 
        \args -> Eval(\vals, conf -> 
            if (length(args) != 1) flow(undefVal) else {
                flow(b2s(flow2b(args[0].eval(vals, conf))))
            }
        ),
        showDfEvalOper("b2s")
    )
];
